<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 로그인 처리</title>
</head>
<body>
    <script>
        function getAuthCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('code'); // 🔥 Authorization Code 가져오기
        }

        async function sendAuthCodeToBackend(authCode) {
            try {
                const response = await fetch('http://localhost:3000/auth/google', { // 🔥 백엔드로 Authorization Code 전달
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: authCode })
                });

                const data = await response.json();
                console.log('Google Access Token:', data.access_token);

                if (data.access_token) {
                    fetchUserInfo(data.access_token);
                } else {
                    console.error('토큰 요청 실패:', data);
                    window.location.href = 'index.html'; // 로그인 페이지로 돌아가기
                }

            } catch (error) {
                console.error('백엔드 요청 오류:', error);
            }
        }

        async function fetchUserInfo(accessToken) {
            console.log("📥 Google API 요청: Access Token 사용", accessToken);

            const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: { Authorization: `Bearer ${accessToken}` }
            });

            const userInfo = await response.json();
            console.log('Google 사용자 정보:', userInfo);

            // ✅ 로컬 스토리지에 저장
            localStorage.setItem('googleUser', JSON.stringify(userInfo));
            localStorage.setItem("access_token",accessToken);
            // ✅ 메인 페이지로 이동
            window.location.href = 'mainpage.html';
        }

        const authCode = getAuthCode();
        if (authCode) {
            sendAuthCodeToBackend(authCode); // 🔥 백엔드로 Authorization Code 전송
        } else {
            console.error('Authorization Code 없음');
            window.location.href = 'index.html'; // 실패 시 로그인 페이지로 이동
        }
    </script>
</body>
</html>
